{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}
    {% if editing %}Edit Shared Question - Climas{% else %}Create Shared Question - Climas{% endif %}
{% endblock %}

{% block content %}
<div class="container" style="max-width: 700px; margin: 3rem auto;">
    <h3 class="mb-4">
        {% if editing %}Edit Question: {{ question.question }}{% else %}Create New Shared Question{% endif %}
    </h3>
    
    <form method="post">
        {% csrf_token %}
        
        <div class="mb-3">
            <label for="{{ form.question.id_for_label }}" class="form-label">Question Text</label>
            {{ form.question|attr:"class:form-control" }}
            {% if form.question.errors %}
                <div class="text-danger small mt-1">{{ form.question.errors|join:", " }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="{{ form.field_type.id_for_label }}" class="form-label">Field Type</label>
            {{ form.field_type|attr:"class:form-select" }}
            {% if form.field_type.errors %}
                <div class="text-danger small mt-1">{{ form.field_type.errors|join:", " }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="{{ form.target_category.id_for_label }}" class="form-label">Target Category</label>
            {{ form.target_category|attr:"class:form-select" }}
            {% if form.target_category.errors %}
                <div class="text-danger small mt-1">{{ form.target_category.errors|join:", " }}</div>
            {% endif %}
        </div>

        <!-- Options Field -->
        <div class="mb-3" id="optionsField">
            <label for="{{ form.options.id_for_label }}" class="form-label">Options (JSON - for dropdown/radio)</label>
            {{ form.options|attr:"class:form-control" }}
            {% if form.options.errors %}
                <div class="text-danger small mt-1">{{ form.options.errors|join:", " }}</div>
            {% endif %}
            <small class="form-text text-muted">Example: ["Yes", "No", "Maybe"]</small>
        </div>

        <!-- Source Model Field -->
        <div class="mb-4" id="sourceModelField">
            <label for="{{ form.source_model.id_for_label }}" class="form-label">Source Model (Dynamic Options)</label>
            {{ form.source_model|attr:"class:form-select" }}
            {% if form.source_model.errors %}
                <div class="text-danger small mt-1">{{ form.source_model.errors|join:", " }}</div>
            {% endif %}
            <small class="form-text text-muted">Leave blank if using static options above.</small>

            <!-- Preview Area -->
            <div id="sourceModelPreview" class="mt-3 p-3 border rounded" style="display: none; background-color: #f8f9fa;">
                <h6 class="mb-2">Preview (first 5 items):</h6>
                <ul id="previewList" class="mb-0" style="max-height: 150px; overflow-y: auto;"></ul>
                <small class="text-muted">Showing "name" field values.</small>
            </div>
        </div>
        
        <div class="mb-4">
            <div class="form-check form-switch mb-2">
                {{ form.is_required|attr:"class:form-check-input" }}
                <label class="form-check-label" for="{{ form.is_required.id_for_label }}">
                    {{ form.is_required.label }}
                </label>
            </div>
            <div class="form-check form-switch">
                {{ form.is_active|attr:"class:form-check-input" }}
                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                    {{ form.is_active.label }}
                </label>
            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{% url 'calls:coordinator_dashboard' %}" class="btn btn-secondary me-md-2">Cancel</a>
            <button type="submit" class="btn btn-primary">
                {% if editing %}Update Question{% else %}Create Question{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fieldTypeSelect = document.querySelector('select[name="field_type"]');
    const optionsField = document.getElementById('optionsField');
    const sourceModelField = document.getElementById('sourceModelField');
    const sourceModelSelect = document.querySelector('select[name="source_model"]');
    const previewDiv = document.getElementById('sourceModelPreview');
    const previewList = document.getElementById('previewList');

    function toggleFields() {
        const selectedType = fieldTypeSelect.value;

        if (selectedType === 'radio' || selectedType === 'dropdown') {
            // Show options, hide source_model for static dropdown/radio
            optionsField.style.display = 'block';
            sourceModelField.style.display = 'none';
            previewDiv.style.display = 'none';
        } else if (selectedType === 'dynamic_dropdown') {
            // Hide options, show source_model for dynamic dropdown
            optionsField.style.display = 'none';
            sourceModelField.style.display = 'block';
        } else {
            // Hide both for other types
            optionsField.style.display = 'none';
            sourceModelField.style.display = 'none';
            previewDiv.style.display = 'none';
        }
    }

    // Initialize on page load
    if (fieldTypeSelect) {
        toggleFields(); // Set initial state
        fieldTypeSelect.addEventListener('change', toggleFields); // Attach event listener
    }

    // Preview functionality
    if (sourceModelSelect) {
        sourceModelSelect.addEventListener('change', function() {
            const selectedValue = this.value;

            if (!selectedValue) {
                previewDiv.style.display = 'none';
                return;
            }

            // Show loading
            previewList.innerHTML = '<li>Loading...</li>';
            previewDiv.style.display = 'block';

            fetch(`/calls/shared-question/preview/${selectedValue}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.items.length > 0) {
                        previewList.innerHTML = data.items.map(item => 
                            `<li>${item}</li>`
                        ).join('');
                    } else {
                        previewList.innerHTML = '<li class="text-muted">No data found or model has no "name" field.</li>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching preview:', error);
                    previewList.innerHTML = '<li class="text-danger">Error loading preview.</li>';
                });
        });
    }
});
</script>
{% endblock %}