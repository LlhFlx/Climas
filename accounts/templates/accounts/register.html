{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Register - Climas{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8" style="margin-top: 5rem;"> <!-- Wider container for two columns -->
            <h4 class="text-center mb-4">Regístrate como Investigador/a</h4>
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post">
                {% csrf_token %}

                <div class="row">
                    <!-- === Left Column: Account Information === -->
                    <div class="col-md-6 pe-md-4">
                        <h5 class="mb-3">Información de la Cuenta</h5>

                        <div class="mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">Nombre de Usuario</label>
                            {{ form.username|attr:"class:form-control" }}
                            {% if form.username.errors %}
                                <div class="text-danger small">{{ form.username.errors.0 }}</div>
                            {% endif %}
                            {% if form.username.help_text %}
                                <small class="form-text text-muted">{{ form.username.help_text }}</small>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                            {{ form.email|attr:"class:form-control" }}
                            {% if form.email.errors %}
                                <div class="text-danger small">{{ form.email.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">Número de Teléfono (Opcional)</label>
                            {{ form.phone_number|attr:"class:form-control" }}
                            <small class="form-text text-muted">Format: +57(601)1234444 or +1 555-123-4567</small>
                            {% if form.phone_number.errors %}
                                <div class="text-danger small">{{ form.phone_number.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.password1.id_for_label }}" class="form-label">Contraseña</label>
                            {{ form.password1|attr:"class:form-control" }}
                            {% if form.password1.errors %}
                                <div class="text-danger small">{{ form.password1.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.password2.id_for_label }}" class="form-label">Confirmar Contraseña</label>
                            {{ form.password2|attr:"class:form-control" }}
                            {% if form.password2.errors %}
                                <div class="text-danger small">{{ form.password2.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- === Right Column: Personal Information === -->
                    
                    <div class="col-md-6 ps-md-4">
                        <h5 class="mb-3">Información Personal</h5>
                        
                        <div class="mb-3">
                            <label for="{{ form.country.id_for_label }}" class="form-label">País</label>
                            {{ form.country|attr:"class:form-control u-full-width" }}
                            {% if form.country.errors %}
                                <div class="text-danger small mt-1">{{ form.country.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.document_type.id_for_label }}" class="form-label">Tipo de Documento</label>
                            {{ form.document_type|attr:"class:form-select" }}
                            {% if form.document_type.errors %}
                                <div class="text-danger small">{{ form.document_type.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.document_number.id_for_label }}" class="form-label">Número de Documento</label>
                            {{ form.document_number|attr:"class:form-control" }}
                            {% if form.document_number.errors %}
                                <div class="text-danger small">{{ form.document_number.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.first_name.id_for_label }}" class="form-label">Primer Nombre</label>
                            {{ form.first_name|attr:"class:form-control" }}
                            {% if form.first_name.errors %}
                                <div class="text-danger small">{{ form.first_name.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.second_name.id_for_label }}" class="form-label">Segundo Nombre (Opcional)</label>
                            {{ form.second_name|attr:"class:form-control" }}
                            {% if form.second_name.errors %}
                                <div class="text-danger small">{{ form.second_name.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.first_last_name.id_for_label }}" class="form-label">Primer Apellido</label>
                            {{ form.first_last_name|attr:"class:form-control" }}
                            {% if form.first_last_name.errors %}
                                <div class="text-danger small">{{ form.first_last_name.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.second_last_name.id_for_label }}" class="form-label">Segundo Apellido</label>
                            {{ form.second_last_name|attr:"class:form-control" }}
                            {% if form.second_last_name.errors %}
                                <div class="text-danger small">{{ form.second_last_name.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.gender.id_for_label }}" class="form-label">Género</label>
                            {{ form.gender|attr:"class:form-select" }}
                            {% if form.gender.errors %}
                                <div class="text-danger small">{{ form.gender.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- CAPTCHA FIELD -->
                <div class="mb-4">
                    {{ form.captcha.label_tag }}
                    {{ form.captcha }}
                    {% if form.captcha.errors %}
                        {% for error in form.captcha.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                    <small class="form-text text-muted">Por favor, confirme que no es un robot.</small>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary px-5">Registrar</button>
                </div>
            </form>
 
            <p class="mt-3 text-center">
                ¿Ya tienes una cuenta? <a href="{% url 'accounts:login' %}">Inicia sesión aquí</a>
            </p>
            
            <hr>
            <p class="text-center"><strong>¿Necesitas acceso de Coordinador o Evaluador?</strong></p>
            <p class="text-muted text-center">Esos roles requieren aprobación. Primero regístrate como Investigador (usando este formulario), luego solicita acceso elevado para tu perfil a un administrador.</p>
        </div>
    </div>
</div>
{% endblock content %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const countrySelect = document.getElementById('id_country');
    const docTypeSelect = document.getElementById('id_document_type');

    function updateDocumentTypes(countryId) {
        if (!countryId) {
            docTypeSelect.innerHTML = '<option value="">Select country first</option>';
            return;
        }

        fetch(`/accounts/document-types/${countryId}/`)
            .then(response => response.json())
            .then(data => {
                docTypeSelect.innerHTML = '<option value="">Select document type</option>';
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    docTypeSelect.appendChild(option);
                });
            })
            .catch(err => {
                console.error('Failed to load document types:', err);
                docTypeSelect.innerHTML = '<option value="">Error loading types</option>';
            });
    }

    // Initialize if country is pre-selected (e.g., form error reload)
    if (countrySelect.value) {
        updateDocumentTypes(countrySelect.value);
    }

    countrySelect.addEventListener('change', function () {
        updateDocumentTypes(this.value);
    });
});
</script>
{% endblock %}