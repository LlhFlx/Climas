{% extends 'base.html' %}
{% load humanize %}
{% block title %}Evaluar: {{ evaluation.target.project_title }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <h3>Evaluando: "{{ evaluation.target.project_title }}"</h3>
    <p><strong>Convocatoria:</strong> {{ evaluation.call.title }}</p>
    <p><strong>Plantilla:</strong> {{ evaluation.template.name }}</p>
    <p><strong>Tipo:</strong>
        {% if target_type == 'expression' %}
            <span class="badge bg-info">Expresión</span>
        {% else %}
            <span class="badge bg-success">Propuesta</span>
        {% endif %}
    </p>

    <hr>

    <!-- Read-only Project Info -->
    <div class="mb-4">
        <h5>Datos del Proyecto</h5>
        <ul class="list-group">

            <!-- Evaluation Target Information Card -->
            <div class="card mb-4 shadow-sm expression-fields-card">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0 fw-bold text-body">
                        {% if target_type == 'proposal' %}
                            Información de la Propuesta
                        {% else %}
                            Información de la Expresión de Interés
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body p-0">
                    <!-- BASIC FIELDS -->
                    <div class="field-row">
                        <span class="field-label">Título:</span>
                        <span class="field-value text-break">
                            {{ evaluation.target.project_title_override|default:evaluation.target.project_title }}
                        </span>
                    </div>
                    <div class="field-row">
                        <span class="field-label">Investigador Principal:</span>
                        <span class="field-value text-break">
                            {{ evaluation.target.user.person|default:evaluation.target.user.user.username }}
                        </span>
                    </div>
                    <div class="field-row">
                        <span class="field-label">País:</span>
                        <span class="field-value text-break">
                            {{ evaluation.target.project_location.name }}
                        </span>
                    </div>
                    <div class="field-row">
                        <span class="field-label">Problema:</span>
                        <span class="field-value text-break">
                            {{ evaluation.target.problem|truncatewords:50|linebreaksbr }}
                        </span>
                    </div>
                    <div class="field-row">
                        <span class="field-label">Objetivo General:</span>
                        <span class="field-value text-break">
                            {{ evaluation.target.general_objective|truncatewords:50|linebreaksbr }}
                        </span>
                    </div>
                    <div class="field-row">
                        <span class="field-label">Metodología:</span>
                        <span class="field-value text-break">
                            {{ evaluation.target.methodology|truncatewords:50|linebreaksbr }}
                        </span>
                    </div>

                    <!-- PRODUCTS -->
                    {% if products %}
                        <div class="field-row">
                            <span class="field-label">Productos del Proyecto:</span>
                            <span class="field-value">
                                <ul class="mt-1 mb-0">
                                    {% for product in products %}
                                        <li class="mb-2">
                                            <strong>{{ product.title }}</strong><br>
                                            <em>{{ product.description|default:"Sin descripción" }}</em><br>
                                            <small><strong>Efectos estratégicos:</strong></small>
                                            {% if product.strategic_effects.all %}
                                                <ul class="list-unstyled ms-3 mb-1 text-muted" style="font-size: 0.95rem;">
                                                    {% for effect in product.strategic_effects.all %}
                                                        <li>• <span class="text-dark">{{ effect.name }}</span></li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p class="ms-4 text-muted mb-0" style="font-size: 0.9rem;">No asignados</p>
                                            {% endif %}
                                            <!-- <small><strong>Fechas:</strong> {{ product.start_date|date:"Y-m-d" }} &rarr; {{ product.end_date|date:"Y-m-d" }}</small> -->
                                        </li>
                                    {% endfor %}
                                </ul>
                            </span>
                        </div>
                    {% endif %}

                    <!-- TEAM MEMBERS -->
                    {% if team_members %}
                        <div class="field-row">
                            <span class="field-label">Colaboradores del Proyecto:</span>
                            <span class="field-value">
                                <ul class="mt-1 mb-0">
                                    {% for member in team_members %}
                                        <li class="mb-3">
                                            <strong>{{ member.person.first_name }} {{ member.person.first_last_name }}</strong><br>
                                            Rol: {{ member.role }}<br>
                                            Institución: {{ member.institution.name }}<br>
                                            <small>({{ member.start_date|date:"Y-m-d" }} → {{ member.end_date|date:"Y-m-d" }})</small>

                                            {% if member.thematic_antecedents.exists %}
                                                <ul class="mt-2 mb-0">
                                                    {% for antecedent in member.thematic_antecedents.all %}
                                                        <li class="mb-1">
                                                            <em>Eje Temático:</em> {{ antecedent.thematic_axis.name }}<br>
                                                            <em>Descripción:</em> {{ antecedent.description|linebreaksbr }}<br>
                                                            {% if antecedent.evidence_url %}
                                                                <em>Evidencia:</em>
                                                                <a href="{{ antecedent.evidence_url }}" target="_blank" class="text-decoration-none">
                                                                    {{ antecedent.evidence_url }}
                                                                </a>
                                                            {% endif %}
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p class="text-muted mb-0 mt-1">Sin antecedentes temáticos registrados.</p>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </span>
                        </div>
                    {% endif %}

                    <!-- PROPOSAL-SPECIFIC FIELDS -->
                    {% if target_type == 'proposal' %}
                        <div class="field-row">
                            <span class="field-label">Experiencia en Investigación del Investigador Principal:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.principal_research_experience|default:"No proporcionado"|linebreaksbr }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">País de la Comunidad:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.community_country.name|default:"No especificado" }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">Descripción de la Comunidad:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.community_description|default:"No proporcionada"|linebreaksbr }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">País de Implementación del Proyecto:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.project_location.name|default:"No especificado" }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">Duración del Proyecto (meses):</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.duration_months|default:"No especificada" }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">Resumen:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.summary|default:"No proporcionado"|linebreaksbr }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">Contexto, Problema y Justificación:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.context_problem_justification|default:"No proporcionado"|linebreaksbr }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">Objetivos Específicos:</span>
                            <span class="field-value">
                                {% if proposal_fields.specific_objectives.exists %}
                                    <ul class="mb-0">
                                        {% for obj in proposal_fields.specific_objectives %}
                                            <li>
                                                <strong>{{ obj.title }}</strong>
                                                {% if obj.description %}
                                                    <br><small>{{ obj.description|linebreaksbr }}</small>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <em>No proporcionados</em>
                                {% endif %}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">Metodología, Plan Analítico y Ética:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.methodology_analytical_plan_ethics|default:"No proporcionado"|linebreaksbr }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">Equidad, Género, Interseccionalidad e Inclusión:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.equity_inclusion|default:"No proporcionado"|linebreaksbr }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">Estrategia de Comunicación:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.communication_strategy|default:"No proporcionada"|linebreaksbr }}
                            </span>
                        </div>
                        <div class="field-row">
                            <span class="field-label">Riesgos y Mitigación:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.risk_analysis_mitigation|default:"No proporcionado"|linebreaksbr }}
                            </span>
                        </div>
                        <!-- <div class="field-row">
                            <span class="field-label">Equipo de Investigación:</span>
                            <span class="field-value text-break">
                                {{ proposal_fields.research_team|default:"No proporcionado"|linebreaksbr }}
                            </span>
                        </div> -->
                    {% endif %}

                    <!-- DYNAMIC QUESTIONS -->
                    {% if responses %}
                        <div class="field-row">
                            <span class="field-label">Preguntas de Rúbrica de Proponentes:</span>
                            <span class="field-value">
                                <ul class="mb-0">
                                    {% for question, answer in responses.items %}
                                        <li class="mb-2">
                                            <strong>{{ question }}</strong>:<br>
                                            {{ answer|linebreaksbr }}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </span>
                        </div>
                    {% endif %}
                </div>
            </div>


            <!-- DOCUMENTS -->
            {% if target_type == 'proposal' %}
                {% if proposal_fields.timeline_document %}
                    <li class="list-group-item">
                        <strong>Cronograma:</strong>
                        <div class="mt-2">
                            <a href="{% url 'evaluations:download_evaluation_document' evaluation.id 'timeline' %}"
                                class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-file-excel"></i> Descargar Cronograma
                            </a>
                        </div>
                    </li>
                {% endif %}
                {% if proposal_fields.budget_document %}
                    <li class="list-group-item">
                        <strong>Presupuesto:</strong>
                        <div class="mt-2">
                            <a href="{% url 'evaluations:download_evaluation_document' evaluation.id 'budget' %}"
                                class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-file-excel"></i> Descargar Presupuesto
                            </a>
                        </div>
                    </li>
                {% endif %}
            {% endif %}

            <!-- PARTNER INSTITUTIONS & COMMITMENT LETTERS -->
            {% if target_type == 'proposal' %}
                {% if proposal_fields.partner_institutions %}
                    <li class="list-group-item">
                        <strong>Instituciones Aliadas:</strong>
                        <ul class="mt-1">
                            {% for inst in proposal_fields.partner_institutions %}
                                <li>{{ inst.name }}</li>
                            {% endfor %}
                        </ul>
                    </li>
                {% endif %}
                {% if proposal_fields.partner_institution_commitments %}
                    <li class="list-group-item">
                        <strong>Cartas de Compromiso:</strong>
                        <ul class="mt-1">
                            {% for doc in proposal_fields.partner_institution_commitments %}
                                <li>
                                    <a href="{{ doc.file.url }}" target="_blank" class="text-decoration-none">{{ doc.name }}</a>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                {% endif %}
            {% endif %}
        </ul>
    </div>

    <!-- EVALUATION FORM -->
    <form method="post">
        {% csrf_token %}
        <h5>Preguntas de Evaluación</h5>
        {% for item in items %}
            <div class="card mb-3">
                <div class="card-body">
                    <p><strong>{{ item.question }}</strong> (Max: {{ item.max_score }})</p>
                    <div class="row">
                        <div class="col-md-6">

                            {% if item.field_type == 'dropdown' and item.options %}
                                <label for="item_{{ item.id }}">Seleccione una opción</label>
                                <select name="item_{{ item.id }}" id="item_{{ item.id }}" class="form-select" required>
                                    <option value="">-- Seleccione --</option>
                                    {% for option in item.options.all %}
                                        <option value="{{ option.id }}">{{ option.display_text }}</option>
                                    {% endfor %}
                                </select>

                            {% elif item.field_type == 'number' %}
                                <label for="item_{{ item.id }}">Puntaje (0 - {{ item.max_score }})</label>
                                <input type="number"
                                    step="0.1"
                                    min="0"
                                    max="{{ item.max_score }}"
                                    name="item_{{ item.id }}"
                                    id="item_{{ item.id }}"
                                    class="form-control"
                                    required>

                            {% elif item.field_type == 'text' %}
                                <label for="item_{{ item.id }}">Respuesta</label>
                                <textarea name="item_{{ item.id }}" id="item_{{ item.id }}" class="form-control" rows="2" required></textarea>

                            {% else %}
                                <!-- Fallback to number input -->
                                <label for="item_{{ item.id }}">Puntaje (0 - {{ item.max_score }})</label>
                                <input type="number"
                                    step="0.1"
                                    min="0"
                                    max="{{ item.max_score }}"
                                    name="item_{{ item.id }}"
                                    id="item_{{ item.id }}"
                                    class="form-control"
                                    required>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label for="comment_{{ item.id }}">Comentario</label>
                            <textarea name="comment_{{ item.id }}" id="comment_{{ item.id }}" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <p>No hay ítems en esta plantilla.</p>
        {% endfor %}

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <a href="{% url 'evaluations:evaluator_dashboard' %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Enviar Evaluación</button>
        </div>
    </form>
</div>
{% endblock %}