{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}Evaluaciones - Dashboard del Coordinador{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Gestión de Evaluaciones</h2>

    <!-- Tab Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="evaluationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="expressions-tab" data-bs-toggle="tab" href="#expressions" role="tab">Expresiones Enviadas</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="evaluators-tab" data-bs-toggle="tab" href="#evaluators" role="tab">Evaluadores Disponibles</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="evaluationTabsContent">

        <!-- Submitted Expressions -->
        <div class="tab-pane fade show active" id="expressions" role="tabpanel">
            <h4>Expresiones Enviadas ({{ submitted_expressions.count }})</h4>
            {% if submitted_expressions %}
                {% for expr in submitted_expressions %}
                    {% if not expr.first_evaluation.template %}
                        {% if forloop.first %}
                            <div class="alert alert-warning">
                                <strong>⚠️ Advertencia:</strong> Algunas expresiones no tienen plantilla asignada.
                            </div>
                            {% break %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Asignar Evaluadores</h5>
                </div>
                <div class="card-body">
                    {% if submitted_expressions or proposals %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Proyecto</th>
                                        <th>Investigador</th>
                                        <th>Convocatoria</th>
                                        <th>Fecha</th>
                                        <th>Evaluador</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Expressions -->
                                    {% for expr in submitted_expressions %}
                                        <tr>
                                            <td><span class="badge bg-info">Expresión</span></td>
                                            <td>{{ expr.project_title|truncatechars:40 }}</td>
                                            <td>{{ expr.user.person|default:expr.user.user.username }}</td>
                                            <td>{{ expr.call.title|truncatechars:30 }}</td>
                                            <td>{{ expr.submission_datetime|date:"Y-m-d H:i" }}</td>
                                            <td>
                                                <form method="post" action="{% url 'evaluations:assign_evaluator' 'expression' expr.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    <select name="evaluator_id" class="form-select form-select-sm" required>
                                                        <option value="">-- Asignar --</option>
                                                        {% for evaluator in evaluators %}
                                                            <option value="{{ evaluator.id }}">{{ evaluator.person|default:evaluator.user.username }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <select name="template_id" class="form-select form-select-sm">
                                                        <option value="">-- Plantilla --</option>
                                                        {% for template in expr.call.evaluation_templates.all %}
                                                            {% if template.applies_to_expression %}
                                                                <option value="{{ template.id }}">{{ template.name }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                    <button type="submit" class="btn btn-sm btn-primary mt-1">Asignar</button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}

                                    <!-- Proposals -->
                                    {% for prop in proposals %}
                                        <tr>
                                            <td><span class="badge bg-success">Propuesta</span></td>
                                            <td>{{ prop.project_title|truncatechars:40 }}</td>
                                            <td>{{ prop.user.person|default:prop.user.user.username }}</td>
                                            <td>{{ prop.call.title|truncatechars:30 }}</td>
                                            <td>{{ prop.submission_datetime|date:"Y-m-d H:i" }}</td>
                                            <td>
                                                <form method="post" action="{% url 'evaluations:assign_evaluator' 'proposal' prop.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    <select name="evaluator_id" class="form-select form-select-sm" required>
                                                        <option value="">-- Asignar --</option>
                                                        {% for evaluator in evaluators %}
                                                            <option value="{{ evaluator.id }}">{{ evaluator.person|default:evaluator.user.username }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <select name="template_id" class="form-select form-select-sm">
                                                        <option value="">-- Plantilla --</option>
                                                        {% for template in prop.call.evaluation_templates.all %}
                                                            {% if template.applies_to_proposal %}
                                                                <option value="{{ template.id }}">{{ template.name }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                    <button type="submit" class="btn btn-sm btn-primary mt-1">Asignar</button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">No hay expresiones ni propuestas para asignar evaluadores.</div>
                    {% endif %}
                </div>
            </div>

        <!-- Approved Proposals -->
        <div class="tab-pane fade" id="proposals" role="tabpanel">
            <h4>Propuestas Aprobadas ({{ proposals.count }})</h4>
            {% if proposals %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Proyecto</th>
                                <th>Investigador</th>
                                <th>Convocatoria</th>
                                <th>Fecha</th>
                                <th>Evaluador</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prop in proposals %}
                                <tr>
                                    <td>{{ prop.project_title|truncatechars:40 }}</td>
                                    <td>{{ prop.user.person|default:prop.user.user.username }}</td>
                                    <td>{{ prop.call.title|truncatechars:30 }}</td>
                                    <td>{{ prop.submission_datetime|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <form method="post" action="{% url 'evaluations:assign_evaluator' 'proposal' prop.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <select name="evaluator_id" class="form-select form-select-sm" required>
                                                <option value="">-- Asignar --</option>
                                                {% for evaluator in evaluators %}
                                                    <option value="{{ evaluator.id }}">{{ evaluator.person|default:evaluator.user.username }}</option>
                                                {% endfor %}
                                            </select>
                                            <select name="template_id" class="form-select form-select-sm">
                                                <option value="">-- Plantilla --</option>
                                                {% for template in prop.call.evaluation_templates.all %}
                                                    {% if template.applies_to_proposal %}
                                                        <option value="{{ template.id }}">{{ template.name }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                            <button type="submit" class="btn btn-sm btn-primary mt-1">Asignar</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">No hay propuestas aprobadas aún.</div>
            {% endif %}
        </div>

        <!-- Evaluators -->
        <div class="tab-pane fade" id="evaluators" role="tabpanel">
            <h4>Evaluadores Disponibles ({{ evaluators.count }})</h4>
            {% if evaluators %}
                <div class="list-group">
                    {% for evaluator in evaluators %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ evaluator.person|default:evaluator.user.username }}</strong><br>
                                <small class="text-muted">{{ evaluator.user.email }}</small>
                            </div>
                            <span class="badge bg-primary">Evaluador</span>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-warning">No hay evaluadores registrados. Cree uno en <a href="{% url 'accounts:register' %}">Registro</a> y asigne el rol 'Evaluator'.</div>
            {% endif %}
        </div>

    </div>

    <!-- Link to Coordinator Dashboard -->
    <div class="mt-4">
        <a href="{% url 'calls:coordinator_dashboard' %}" class="btn btn-outline-secondary">← Volver al Dashboard</a>
    </div>
</div>
{% endblock %}